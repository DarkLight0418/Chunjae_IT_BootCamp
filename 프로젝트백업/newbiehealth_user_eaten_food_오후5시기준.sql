-- 테이블 newbiehealth.user_eaten_food 구조 내보내기
CREATE TABLE IF NOT EXISTS `user_eaten_food` (
  `record_id` int(11) NOT NULL AUTO_INCREMENT,
  `user_key` varchar(20) DEFAULT NULL,
  `meal_type` enum('아침','점심','저녁','간식') DEFAULT NULL,
  `food_id` int(11) DEFAULT NULL,
  `quantity` int(11) DEFAULT NULL,
  `date` date DEFAULT NULL,
  `created_at` date DEFAULT NULL,
  `intaked_calories` int(11) DEFAULT NULL,
  PRIMARY KEY (`record_id`),
  KEY `FK_userkey` (`user_key`),
  KEY `FK_foodId` (`food_id`),
  CONSTRAINT `FK_foodId` FOREIGN KEY (`food_id`) REFERENCES `food` (`food_id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `FK_userkey` FOREIGN KEY (`user_key`) REFERENCES `user` (`user_key`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

ALTER TABLE `user_eaten_food` DROP FOREIGN KEY `FK_foodId`;
ALTER TABLE `user_eaten_food` DROP FOREIGN KEY `FK_userkey`;

ALTER TABLE `user_eaten_food`
ADD CONSTRAINT `FK_foodId` FOREIGN KEY (`food_id`) REFERENCES `food` (`food_id`) ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE `user_eaten_food`
ADD CONSTRAINT `FK_userkey` FOREIGN KEY (`user_key`) REFERENCES `user` (`user_key`) ON DELETE RESTRICT ON UPDATE RESTRICT;


-- 트리거 본문에서 세미콜론(;)을 자유롭게 쓰기 위해 임시 구분자를 // 로 변경
DELIMITER //

-- 재실행 시 에러를 피하려고, 동일 이름 트리거가 있으면 먼저 삭제
DROP TRIGGER IF EXISTS trg_user_eaten_food_bi//
/*
 * trg_user_eaten_food_bi
 * - 시점: BEFORE INSERT
 * - 목적: user_eaten_food에 새 행이 들어올 때,
 *         food.food_calories를 조회해 intaked_calories를 자동 계산/주입
 * - 정책: 관대 정책(에러 발생 X). 조회 실패/NULL도 0으로 간주해 계산
 */
CREATE TRIGGER trg_user_eaten_food_bi
BEFORE INSERT ON user_eaten_food
FOR EACH ROW
BEGIN
  -- 참조한 음식 칼로리를 담을 임시 변수
  DECLARE v_cal INT;

  -- food_id가 가리키는 음식의 칼로리를 조회 (없으면 v_cal은 NULL)
  SELECT food_calories INTO v_cal
  FROM food
  WHERE food_id = NEW.food_id;

  -- NULL 안전 계산:
  --  - quantity가 NULL이면 0 취급
  --  - v_cal(조회 칼로리)가 NULL이면 0 취급
  -- → 결과적으로 잘못된 참조/누락이어도 에러 없이 0으로 저장
  SET NEW.intaked_calories = COALESCE(NEW.quantity, 0) * COALESCE(v_cal, 0);
END//

DROP TRIGGER IF EXISTS trg_user_eaten_food_bu//
/*
 * trg_user_eaten_food_bu
 * - 시점: BEFORE UPDATE
 * - 목적: user_eaten_food의 행이 수정될 때마다
 *         (food_id/quantity 변경 여부와 무관하게) 항상 재계산
 * - 정책: 관대 정책(에러 발생 X). 조회 실패/NULL도 0으로 간주
 */
CREATE TRIGGER trg_user_eaten_food_bu
BEFORE UPDATE ON user_eaten_food
FOR EACH ROW
BEGIN
  DECLARE v_cal INT;

  -- 현재 NEW.food_id 기준으로 칼로리 조회
  SELECT food_calories INTO v_cal
  FROM food
  WHERE food_id = NEW.food_id;

  -- 항상 재계산해 넣는다 (NULL은 0 처리)
  SET NEW.intaked_calories = COALESCE(NEW.quantity, 0) * COALESCE(v_cal, 0);
END//

-- 구분자를 원래대로 ; 로 복구
DELIMITER ;


-- 테이블 데이터 newbiehealth.user_eaten_food:~193 rows (대략적) 내보내기
INSERT INTO `user_eaten_food` (`record_id`, `user_key`, `meal_type`, `food_id`, `quantity`, `date`, `created_at`, `intaked_calories`) VALUES
	(1, 'U001', '아침', 5, 2, '2025-08-04', '2025-08-04', 172),
	(2, 'U001', '점심', 1, 1, '2025-08-04', '2025-08-04', 165),
	(3, 'U001', '저녁', 7, 1, '2025-08-04', '2025-08-04', 180),
	(4, 'U002', '아침', 5, 1, '2025-08-04', '2025-08-04', NULL),
	(5, 'U002', '점심', 8, 2, '2025-08-04', '2025-08-04', NULL),
	(6, 'U003', '저녁', 19, 1, '2025-08-03', '2025-08-03', NULL),
	(7, 'U003', '간식', 28, 1, '2025-08-03', '2025-08-03', NULL),
	(8, 'U004', '아침', 2, 1, '2025-08-02', '2025-08-02', NULL),
	(9, 'U004', '점심', 6, 2, '2025-08-02', '2025-08-02', NULL),
	(10, 'U004', '저녁', 4, 1, '2025-08-02', '2025-08-02', NULL),
	(11, 'U001', '아침', 6, 1, '2025-07-01', '2025-07-01', 35),
	(12, 'U001', '점심', 4, 2, '2025-07-01', '2025-07-01', 240),
	(13, 'U001', '저녁', 2, 2, '2025-07-01', '2025-07-01', 156),
	(14, 'U001', '아침', 8, 1, '2025-07-02', '2025-07-02', 100),
	(15, 'U001', '점심', 8, 2, '2025-07-02', '2025-07-02', 200),
	(16, 'U001', '저녁', 3, 1, '2025-07-02', '2025-07-02', 160),
	(17, 'U001', '아침', 1, 2, '2025-07-03', '2025-07-03', 330),
	(18, 'U001', '점심', 18, 1, '2025-07-03', '2025-07-03', 70),
	(19, 'U001', '저녁', 4, 1, '2025-07-03', '2025-07-03', 120),
	(20, 'U001', '아침', 1, 2, '2025-07-04', '2025-07-04', 330),
	(21, 'U001', '점심', 6, 1, '2025-07-04', '2025-07-04', 35),
	(22, 'U001', '저녁', 6, 1, '2025-07-04', '2025-07-04', 35),
	(23, 'U001', '아침', 10, 2, '2025-07-05', '2025-07-05', 500),
	(24, 'U001', '점심', 9, 1, '2025-07-05', '2025-07-05', 150),
	(25, 'U001', '저녁', 4, 1, '2025-07-05', '2025-07-05', 120),
	(26, 'U001', '아침', 4, 2, '2025-07-06', '2025-07-06', 240),
	(27, 'U001', '점심', 4, 1, '2025-07-06', '2025-07-06', 120),
	(28, 'U001', '저녁', 18, 1, '2025-07-06', '2025-07-06', 70),
	(29, 'U001', '아침', 8, 1, '2025-07-07', '2025-07-07', 100),
	(30, 'U001', '점심', 8, 2, '2025-07-07', '2025-07-07', 200),
	(31, 'U001', '저녁', 7, 2, '2025-07-07', '2025-07-07', 360),
	(32, 'U001', '아침', 4, 2, '2025-07-08', '2025-07-08', 240),
	(33, 'U001', '점심', 9, 2, '2025-07-08', '2025-07-08', 300),
	(34, 'U001', '저녁', 8, 1, '2025-07-08', '2025-07-08', 100),
	(35, 'U001', '아침', 9, 2, '2025-07-09', '2025-07-09', 300),
	(36, 'U001', '점심', 19, 1, '2025-07-09', '2025-07-09', 220),
	(37, 'U001', '저녁', 9, 1, '2025-07-09', '2025-07-09', 150),
	(38, 'U001', '아침', 7, 1, '2025-07-10', '2025-07-10', 180),
	(39, 'U001', '점심', 10, 1, '2025-07-10', '2025-07-10', 250),
	(40, 'U001', '저녁', 1, 1, '2025-07-10', '2025-07-10', 165),
	(41, 'U001', '아침', 10, 2, '2025-07-11', '2025-07-11', 500),
	(42, 'U001', '점심', 10, 1, '2025-07-11', '2025-07-11', 250),
	(43, 'U001', '저녁', 9, 1, '2025-07-11', '2025-07-11', 150),
	(44, 'U001', '아침', 1, 2, '2025-07-12', '2025-07-12', 330),
	(45, 'U001', '점심', 19, 1, '2025-07-12', '2025-07-12', 220),
	(46, 'U001', '저녁', 6, 2, '2025-07-12', '2025-07-12', 70),
	(47, 'U001', '아침', 19, 1, '2025-07-13', '2025-07-13', 220),
	(48, 'U001', '점심', 4, 1, '2025-07-13', '2025-07-13', 120),
	(49, 'U001', '저녁', 7, 2, '2025-07-13', '2025-07-13', 360),
	(50, 'U001', '아침', 10, 2, '2025-07-14', '2025-07-14', 500),
	(51, 'U001', '점심', 18, 1, '2025-07-14', '2025-07-14', 70),
	(52, 'U001', '저녁', 3, 1, '2025-07-14', '2025-07-14', 160),
	(53, 'U001', '아침', 4, 1, '2025-07-15', '2025-07-15', 120),
	(54, 'U001', '점심', 5, 1, '2025-07-15', '2025-07-15', 86),
	(55, 'U001', '저녁', 1, 2, '2025-07-15', '2025-07-15', 330),
	(56, 'U001', '아침', 8, 1, '2025-07-16', '2025-07-16', 100),
	(57, 'U001', '점심', 6, 1, '2025-07-16', '2025-07-16', 35),
	(58, 'U001', '저녁', 7, 1, '2025-07-16', '2025-07-16', 180),
	(59, 'U001', '아침', 3, 1, '2025-07-17', '2025-07-17', 160),
	(60, 'U001', '점심', 9, 2, '2025-07-17', '2025-07-17', 300),
	(61, 'U001', '저녁', 7, 1, '2025-07-17', '2025-07-17', 180),
	(62, 'U001', '아침', 7, 2, '2025-07-18', '2025-07-18', 360),
	(63, 'U001', '점심', 3, 1, '2025-07-18', '2025-07-18', 160),
	(64, 'U001', '저녁', 19, 2, '2025-07-18', '2025-07-18', 440),
	(65, 'U001', '아침', 7, 1, '2025-07-19', '2025-07-19', 180),
	(66, 'U001', '점심', 18, 1, '2025-07-19', '2025-07-19', 70),
	(67, 'U001', '저녁', 10, 2, '2025-07-19', '2025-07-19', 500),
	(68, 'U001', '아침', 10, 2, '2025-07-20', '2025-07-20', 500),
	(69, 'U001', '점심', 18, 2, '2025-07-20', '2025-07-20', 140),
	(70, 'U001', '저녁', 5, 1, '2025-07-20', '2025-07-20', 86),
	(71, 'U001', '아침', 10, 1, '2025-07-21', '2025-07-21', 250),
	(72, 'U001', '점심', 5, 2, '2025-07-21', '2025-07-21', 172),
	(73, 'U001', '저녁', 1, 1, '2025-07-21', '2025-07-21', 165),
	(74, 'U001', '아침', 8, 1, '2025-07-22', '2025-07-22', 100),
	(75, 'U001', '점심', 19, 2, '2025-07-22', '2025-07-22', 440),
	(76, 'U001', '저녁', 5, 2, '2025-07-22', '2025-07-22', 172),
	(77, 'U001', '아침', 9, 1, '2025-07-23', '2025-07-23', 150),
	(78, 'U001', '점심', 5, 2, '2025-07-23', '2025-07-23', 172),
	(79, 'U001', '저녁', 8, 1, '2025-07-23', '2025-07-23', 100),
	(80, 'U001', '아침', 2, 2, '2025-07-24', '2025-07-24', 156),
	(81, 'U001', '점심', 2, 2, '2025-07-24', '2025-07-24', 156),
	(82, 'U001', '저녁', 4, 1, '2025-07-24', '2025-07-24', 120),
	(83, 'U001', '아침', 8, 2, '2025-07-25', '2025-07-25', 200),
	(84, 'U001', '점심', 5, 1, '2025-07-25', '2025-07-25', 86),
	(85, 'U001', '저녁', 5, 2, '2025-07-25', '2025-07-25', 172),
	(86, 'U001', '아침', 2, 2, '2025-07-26', '2025-07-26', 156),
	(87, 'U001', '점심', 10, 2, '2025-07-26', '2025-07-26', 500),
	(88, 'U001', '저녁', 9, 1, '2025-07-26', '2025-07-26', 150),
	(89, 'U001', '아침', 9, 2, '2025-07-27', '2025-07-27', 300),
	(90, 'U001', '점심', 2, 1, '2025-07-27', '2025-07-27', 78),
	(91, 'U001', '저녁', 10, 2, '2025-07-27', '2025-07-27', 500),
	(92, 'U001', '아침', 1, 2, '2025-07-28', '2025-07-28', 330),
	(93, 'U001', '점심', 4, 1, '2025-07-28', '2025-07-28', 120),
	(94, 'U001', '저녁', 9, 2, '2025-07-28', '2025-07-28', 300),
	(95, 'U001', '아침', 8, 1, '2025-07-29', '2025-07-29', 100),
	(96, 'U001', '점심', 18, 2, '2025-07-29', '2025-07-29', 140),
	(97, 'U001', '저녁', 19, 1, '2025-07-29', '2025-07-29', 220),
	(98, 'U001', '아침', 10, 2, '2025-07-30', '2025-07-30', 500),
	(99, 'U001', '점심', 9, 1, '2025-07-30', '2025-07-30', 150),
	(100, 'U001', '저녁', 7, 1, '2025-07-30', '2025-07-30', 180),
	(101, 'U001', '아침', 9, 2, '2025-07-31', '2025-07-31', 300),
	(102, 'U001', '점심', 8, 1, '2025-07-31', '2025-07-31', 100),
	(103, 'U001', '저녁', 10, 2, '2025-07-31', '2025-07-31', 500),
	(104, 'U001', '아침', 8, 2, '2025-08-01', '2025-08-01', 200),
	(105, 'U001', '점심', 10, 2, '2025-08-01', '2025-08-01', 500),
	(106, 'U001', '저녁', 5, 2, '2025-08-01', '2025-08-01', 172),
	(107, 'U001', '아침', 6, 2, '2025-08-02', '2025-08-02', 70),
	(108, 'U001', '점심', 6, 2, '2025-08-02', '2025-08-02', 70),
	(109, 'U001', '저녁', 1, 1, '2025-08-02', '2025-08-02', 165),
	(110, 'U001', '아침', 3, 1, '2025-08-03', '2025-08-03', 160),
	(111, 'U001', '점심', 7, 1, '2025-08-03', '2025-08-03', 180),
	(112, 'U001', '저녁', 6, 2, '2025-08-03', '2025-08-03', 70),
	(113, 'U001', '아침', 7, 1, '2025-08-05', '2025-08-05', 180),
	(114, 'U001', '점심', 2, 1, '2025-08-05', '2025-08-05', 78),
	(115, 'U001', '저녁', 7, 1, '2025-08-05', '2025-08-05', 180),
	(116, 'U001', '아침', 8, 2, '2025-08-06', '2025-08-06', 200),
	(117, 'U001', '점심', 1, 2, '2025-08-06', '2025-08-06', 330),
	(118, 'U001', '저녁', 2, 1, '2025-08-06', '2025-08-06', 78),
	(119, 'U001', '아침', 2, 1, '2025-08-07', '2025-08-07', 78),
	(120, 'U001', '점심', 1, 2, '2025-08-07', '2025-08-07', 330),
	(121, 'U001', '저녁', 4, 2, '2025-08-07', '2025-08-07', 240),
	(122, 'U001', '아침', 19, 2, '2025-08-08', '2025-08-08', 440),
	(123, 'U001', '점심', 6, 1, '2025-08-08', '2025-08-08', 35),
	(124, 'U001', '저녁', 7, 2, '2025-08-08', '2025-08-08', 360),
	(125, 'U001', '아침', 1, 2, '2025-08-09', '2025-08-09', 330),
	(126, 'U001', '점심', 19, 2, '2025-08-09', '2025-08-09', 440),
	(127, 'U001', '저녁', 19, 1, '2025-08-09', '2025-08-09', 220),
	(128, 'U001', '아침', 8, 2, '2025-08-10', '2025-08-10', 200),
	(129, 'U001', '점심', 8, 1, '2025-08-10', '2025-08-10', 100),
	(130, 'U001', '저녁', 4, 2, '2025-08-10', '2025-08-10', 240),
	(131, 'U001', '아침', 9, 2, '2025-08-11', '2025-08-11', 300),
	(132, 'U001', '점심', 2, 1, '2025-08-11', '2025-08-11', 78),
	(133, 'U001', '저녁', 2, 1, '2025-08-11', '2025-08-11', 78),
	(134, 'U001', '아침', 4, 2, '2025-08-12', '2025-08-12', 240),
	(135, 'U001', '점심', 6, 2, '2025-08-12', '2025-08-12', 70),
	(136, 'U001', '저녁', 9, 2, '2025-08-12', '2025-08-12', 300),
	(137, 'U001', '아침', 7, 2, '2025-08-13', '2025-08-13', 360),
	(138, 'U001', '점심', 19, 1, '2025-08-13', '2025-08-13', 220),
	(139, 'U001', '저녁', 1, 2, '2025-08-13', '2025-08-13', 330),
	(140, 'U001', '아침', 7, 2, '2025-08-14', '2025-08-14', 360),
	(141, 'U001', '점심', 4, 1, '2025-08-14', '2025-08-14', 120),
	(142, 'U001', '저녁', 18, 2, '2025-08-14', '2025-08-14', 140),
	(143, 'U001', '아침', 6, 2, '2025-08-15', '2025-08-15', 70),
	(144, 'U001', '점심', 5, 2, '2025-08-15', '2025-08-15', 172),
	(145, 'U001', '저녁', 2, 2, '2025-08-15', '2025-08-15', 156),
	(146, 'U001', '아침', 19, 2, '2025-08-16', '2025-08-16', 440),
	(147, 'U001', '점심', 19, 1, '2025-08-16', '2025-08-16', 220),
	(148, 'U001', '저녁', 4, 2, '2025-08-16', '2025-08-16', 240),
	(149, 'U001', '아침', 2, 1, '2025-08-17', '2025-08-17', 78),
	(150, 'U001', '점심', 18, 2, '2025-08-17', '2025-08-17', 140),
	(151, 'U001', '저녁', 7, 1, '2025-08-17', '2025-08-17', 180),
	(152, 'U001', '아침', 1, 2, '2025-08-18', '2025-08-18', 330),
	(153, 'U001', '점심', 19, 2, '2025-08-18', '2025-08-18', 440),
	(154, 'U001', '저녁', 19, 1, '2025-08-18', '2025-08-18', 220),
	(155, 'U001', '아침', 18, 2, '2025-08-19', '2025-08-19', 140),
	(156, 'U001', '점심', 1, 1, '2025-08-19', '2025-08-19', 165),
	(157, 'U001', '저녁', 18, 1, '2025-08-19', '2025-08-19', 70),
	(158, 'U001', '아침', 18, 1, '2025-08-20', '2025-08-20', 70),
	(159, 'U001', '점심', 19, 1, '2025-08-20', '2025-08-20', 220),
	(160, 'U001', '저녁', 3, 2, '2025-08-20', '2025-08-20', 320),
	(161, 'U001', '아침', 3, 1, '2025-08-21', '2025-08-21', 160),
	(162, 'U001', '점심', 18, 1, '2025-08-21', '2025-08-21', 70),
	(163, 'U001', '저녁', 2, 1, '2025-08-21', '2025-08-21', 78),
	(164, 'U001', '아침', 5, 1, '2025-08-22', '2025-08-22', 86),
	(165, 'U001', '점심', 4, 2, '2025-08-22', '2025-08-22', 240),
	(166, 'U001', '저녁', 4, 1, '2025-08-22', '2025-08-22', 120),
	(167, 'U001', '아침', 7, 2, '2025-08-23', '2025-08-23', 360),
	(168, 'U001', '점심', 7, 2, '2025-08-23', '2025-08-23', 360),
	(169, 'U001', '저녁', 7, 1, '2025-08-23', '2025-08-23', 180),
	(170, 'U001', '아침', 7, 2, '2025-08-24', '2025-08-24', 360),
	(171, 'U001', '점심', 10, 1, '2025-08-24', '2025-08-24', 250),
	(172, 'U001', '저녁', 1, 1, '2025-08-24', '2025-08-24', 165),
	(173, 'U001', '아침', 18, 1, '2025-08-25', '2025-08-25', 70),
	(174, 'U001', '점심', 7, 2, '2025-08-25', '2025-08-25', 360),
	(175, 'U001', '저녁', 8, 1, '2025-08-25', '2025-08-25', 100),
	(176, 'U001', '아침', 18, 2, '2025-08-26', '2025-08-26', 140),
	(177, 'U001', '점심', 1, 1, '2025-08-26', '2025-08-26', 165),
	(178, 'U001', '저녁', 19, 2, '2025-08-26', '2025-08-26', 440),
	(179, 'U001', '아침', 5, 1, '2025-08-27', '2025-08-27', 86),
	(180, 'U001', '점심', 19, 2, '2025-08-27', '2025-08-27', 440),
	(181, 'U001', '저녁', 6, 2, '2025-08-27', '2025-08-27', 70),
	(182, 'U001', '아침', 8, 2, '2025-08-28', '2025-08-28', 200),
	(183, 'U001', '점심', 2, 2, '2025-08-28', '2025-08-28', 156),
	(184, 'U001', '저녁', 9, 2, '2025-08-28', '2025-08-28', 300),
	(185, 'U001', '아침', 8, 2, '2025-08-29', '2025-08-29', 200),
	(186, 'U001', '점심', 4, 2, '2025-08-29', '2025-08-29', 240),
	(187, 'U001', '저녁', 9, 2, '2025-08-29', '2025-08-29', 300),
	(188, 'U001', '아침', 4, 1, '2025-08-30', '2025-08-30', 120),
	(189, 'U001', '점심', 7, 2, '2025-08-30', '2025-08-30', 360),
	(190, 'U001', '저녁', 9, 2, '2025-08-30', '2025-08-30', 300),
	(191, 'U001', '아침', 8, 2, '2025-08-31', '2025-08-31', 200),
	(192, 'U001', '점심', 19, 2, '2025-08-31', '2025-08-31', 440),
	(193, 'U001', '저녁', 7, 2, '2025-08-31', '2025-08-31', 360);
